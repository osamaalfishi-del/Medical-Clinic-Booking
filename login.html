<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>تسجيل دخول النظام</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        body { background: #f4f6f9; display: flex; align-items: center; justify-content: center; height: 100vh; }
        .login-box { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); width: 100%; max-width: 420px; text-align: center; }
        .login-box h2 { color: #2c3e50; margin-bottom: 10px; }
        .help { color: #666; font-size: 13px; margin-bottom: 15px; }
        .login-box input { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 6px; }
        .btn-login { width: 100%; padding: 12px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; }
        .btn-login:hover { background: #2980b9; }
        .small { font-size: 13px; color: #666; }
    </style>
</head>
<body>
    <div class="login-box">
        <h2>نظام إدارة العيادة</h2>
        <p class="help" id="helpText">تحميل حالة النظام...</p>

        <form id="loginForm" style="display:none;">
            <input type="password" id="password" placeholder="كلمة المرور" required>
            <button type="submit" class="btn-login">دخول</button>
        </form>

        <form id="setupForm" style="display:none;">
            <input type="password" id="newPassword" placeholder="أنشئ كلمة مرور إدارية (6 أحرف على الأقل)" required>
            <input type="password" id="confirmPassword" placeholder="تأكيد كلمة المرور" required>
            <button type="submit" class="btn-login">إنشاء الحساب</button>
            <p class="small">سيتم تخزين كلمة المرور بصورة مشفرة على المتصفح.</p>
        </form>
    </div>

    <script src="assets/js/security.js"></script>
    <script>
        const helpText = document.getElementById('helpText');
        const loginForm = document.getElementById('loginForm');
        const setupForm = document.getElementById('setupForm');

        async function init() {
            // show setup if admin doesn't exist
            const exists = SecurityManager.adminExists();
            if (!exists) {
                helpText.textContent = 'لم يتم إعداد حساب المدير بعد. أنشئ كلمة مرور الآن.';
                setupForm.style.display = 'block';
            } else {
                helpText.textContent = 'أدخل كلمة المرور للمتابعة';
                loginForm.style.display = 'block';
            }
        }

        document.getElementById('setupForm').onsubmit = async (e) => {
            e.preventDefault();
            const p1 = document.getElementById('newPassword').value;
            const p2 = document.getElementById('confirmPassword').value;
            if (p1 !== p2) return alert('كلمتا المرور غير متطابقتين');
            if (p1.length < 6) return alert('يجب أن تحتوي كلمة المرور على 6 أحرف على الأقل');
            try {
                await SecurityManager.setup(p1);
                alert('تم إنشاء الحساب بنجاح. يرجى تسجيل الدخول الآن.');
                window.location.reload();
            } catch (err) {
                alert(err.message || 'حدث خطأ أثناء الإعداد');
            }
        };

        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            const pass = document.getElementById('password').value;
            const ok = await SecurityManager.login(pass);
            if (ok) {
                window.location.href = 'dashboard.html';
            } else {
                alert('كلمة المرور غير صحيحة');
            }
        };

        init();
    </script>
</body>
</html>